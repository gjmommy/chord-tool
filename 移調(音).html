<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>轉調與和弦小工具</title>
<style>
    body { font-family: "Segoe UI", Arial, sans-serif; padding: 16px; }
    h1 { font-size: 20px; margin-bottom: 8px; }
    table { border-collapse: collapse; margin-top: 8px; margin-bottom: 12px; }
    th, td {
        border: 1px solid #ccc;
        padding: 4px 8px;
        text-align: center;
        min-width: 60px;
        font-size: 13px;
    }
    thead th { background: #e6e6f5; }
    .row-key1 td { background: #ffe5e0; }
    .row-key2 td { background: #e3f6df; }
    .note-cell { cursor: pointer; }
    .note-cell:hover { background: #fff3b0 !important; }
    .controls { margin-bottom: 8px; }
    .controls label { margin-right: 8px; }
    select { padding: 4px; }
    .interval { margin-top: 4px; font-weight: bold; color: #0066aa; }
    .chord-container { margin-top: 12px; display: flex; gap: 24px; flex-wrap: wrap; }
    .chord-table td { text-align: left; padding: 4px 8px; min-width: 80px; }
    .chord-table th { text-align: left; background: #f0f0f0; }
    .explain { font-size: 13px; line-height: 1.6; }
    /* 讓和弦列看起來是可點擊的 */
    .chord-playable { cursor: pointer; }
    .chord-playable:hover { background: #fff3b0; }
</style>
</head>
<body>

<h1>轉調與和弦分析小工具</h1>

<div class="controls">
    <label>
        調性 1：
        <select id="key1">
            <option>C</option>
            <option>C#(Db)</option>
            <option>D</option>
            <option>D#(Eb)</option>
            <option>E</option>
            <option>F</option>
            <option>F#(Gb)</option>
            <option>G</option>
            <option>G#(Ab)</option>
            <option>A</option>
            <option>A#(Bb)</option>
            <option>B</option>
        </select>
    </label>
    <label>
        調性 2：
        <select id="key2">
            <option>C</option>
            <option>C#(Db)</option>
            <option>D</option>
            <option>D#(Eb)</option>
            <option>E</option>
            <option>F</option>
            <option>F#(Gb)</option>
            <option>G</option>
            <option>G#(Ab)</option>
            <option>A</option>
            <option>A#(Bb)</option>
            <option>B</option>
        </select>
    </label>
</div>

<div class="interval">
    音階差 1–2：<span id="intervalText">（請先選擇兩個調性）</span>
</div>

<table>
    <thead>
        <tr>
            <th></th>
            <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th>
            <th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th>
        </tr>
    </thead>
    <tbody>
        <tr class="row-key1">
            <th>調性 1</th>
            <td colspan="12">請選擇調性 1</td>
        </tr>
        <tr class="row-key2">
            <th>調性 2</th>
            <td colspan="12">請選擇調性 2</td>
        </tr>
    </tbody>
</table>

<div class="chord-container">
    <table class="chord-table" border="1">
        <tr><th colspan="2">和弦組成音（點這裡的 Maj / min / 屬7 / 9 會播放和弦）</th></tr>
        <tr>
            <td>根音</td>
            <td id="rootNote"></td>
        </tr>
        <tr class="chord-playable" id="rowMaj">
            <td>Maj</td>
            <td id="majChord"></td>
        </tr>
        <tr class="chord-playable" id="rowMin">
            <td>min</td>
            <td id="minChord"></td>
        </tr>
        <tr class="chord-playable" id="rowDom7">
            <td>屬 7</td>
            <td id="dom7Chord"></td>
        </tr>
        <tr class="chord-playable" id="rowDom9">
            <td>9</td>
            <td id="dom9Chord"></td>
        </tr>
    </table>

    <div class="explain">
        <strong>和弦結構說明</strong><br>
        Maj 和弦 = 根音 ＋ 大三度 ＋ 完全五度<br>
        min 和弦 = 根音 ＋ 小三度 ＋ 完全五度<br>
        屬 7 和弦 = 根音 ＋ 大三度 ＋ 完全五度 ＋ 小七度<br>
        9 和弦 = 根音 ＋ 大三度 ＋ 完全五度 ＋ 小七度 ＋ 九度
    </div>
</div>

<script>
// 12 半音（不含八度資訊）
const NOTES = [
    "C","C#(Db)","D","D#(Eb)","E","F",
    "F#(Gb)","G","G#(Ab)","A","A#(Bb)","B"
];

const key1Select = document.getElementById("key1");
const key2Select = document.getElementById("key2");
const rowKey1 = document.querySelector(".row-key1");
const rowKey2 = document.querySelector(".row-key2");
const intervalText = document.getElementById("intervalText");

// 和弦顯示區
const rootNoteSpan  = document.getElementById("rootNote");
const majChordSpan  = document.getElementById("majChord");
const minChordSpan  = document.getElementById("minChord");
const dom7ChordSpan = document.getElementById("dom7Chord");
const dom9ChordSpan = document.getElementById("dom9Chord");

// 可點擊的和弦列
const rowMaj  = document.getElementById("rowMaj");
const rowMin  = document.getElementById("rowMin");
const rowDom7 = document.getElementById("rowDom7");
const rowDom9 = document.getElementById("rowDom9");

// 記住目前顯示和弦的「根音 index」
let currentRootIndex = null;

// ---- Audio 部分：用 Web Audio API 產生和弦聲音 ----
let audioCtx = null;

function ensureAudioContext() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === "suspended") {
        audioCtx.resume();
    }
}

// 將 0~11 的音階 index 轉成頻率（以 C4=261.63 為基準）
function indexToFrequency(idx) {
    const c4 = 261.63; // C4
    const semitoneFromC = idx; // C=0, C#=1, ..., B=11
    return c4 * Math.pow(2, semitoneFromC / 12);
}

// 播放一個和弦（傳入 index 陣列）
function playChord(indices) {
    if (indices == null || indices.length === 0) return;
    ensureAudioContext();

    const now = audioCtx.currentTime;
    const duration = 1.2;

    indices.forEach(idx => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.type = "sine"; // 你也可以改成 "triangle" 試聽看起來更柔和
        osc.frequency.value = indexToFrequency(idx);

        osc.connect(gain);
        gain.connect(audioCtx.destination);

        // 簡單的 ADSR：快速進音、慢慢淡出
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.4, now + 0.02);       // attack
        gain.gain.linearRampToValueAtTime(0.0, now + duration);   // release

        osc.start(now);
        osc.stop(now + duration + 0.1);
    });
}

// ---- 一般轉調邏輯 ----
key1Select.value = "C";
key2Select.value = "F";

function indexOfNote(note) {
    return NOTES.indexOf(note);
}

function buildSequence(rootNote) {
    const idx = indexOfNote(rootNote);
    if (idx < 0) return [];
    const seq = [];
    for (let i = 0; i < 12; i++) {
        seq.push({ text: NOTES[(idx + i) % 12], index: (idx + i) % 12 });
    }
    return seq;
}

function formatInterval(key1, key2) {
    const p1 = indexOfNote(key1);
    const p2 = indexOfNote(key2);
    if (p1 < 0 || p2 < 0) return "";
    const diff = p2 - p1;
    if (diff === 0) return "0 / 0";

    let main = diff;
    let alt;
    if (diff > 0) {
        alt = diff - 12;
    } else {
        alt = diff + 12;
    }
    const mainStr = (main >= 0 ? "+" + main : "" + main);
    const altStr  = (alt  >= 0 ? "+" + alt  : "" + alt );
    return `${mainStr} / ${altStr}`;
}

// 顯示某一個 index 的和弦組成，並記錄 currentRootIndex
function showChordsFromIndex(idx) {
    currentRootIndex = idx;

    const root = NOTES[idx];
    const maj  = [NOTES[idx], NOTES[(idx+4)%12], NOTES[(idx+7)%12]];
    const min  = [NOTES[idx], NOTES[(idx+3)%12], NOTES[(idx+7)%12]];
    const dom7 = [NOTES[idx], NOTES[(idx+4)%12], NOTES[(idx+7)%12], NOTES[(idx+10)%12]];
    const dom9 = [NOTES[idx], NOTES[(idx+4)%12], NOTES[(idx+7)%12], NOTES[(idx+10)%12], NOTES[(idx+2)%12]];

    rootNoteSpan.textContent  = root;
    majChordSpan.textContent  = maj.join("  ");
    minChordSpan.textContent  = min.join("  ");
    dom7ChordSpan.textContent = dom7.join("  ");
    dom9ChordSpan.textContent = dom9.join("  ");
}

// 更新畫面：重新畫出兩條音階列
function render() {
    const k1 = key1Select.value;
    const k2 = key2Select.value;

    const seq1 = buildSequence(k1);
    const seq2 = buildSequence(k2);

    // 更新音階差顯示
    intervalText.textContent = formatInterval(k1, k2);

    // 清掉原本兩列的 12 個格子（保留左邊的標題 th）
    while (rowKey1.children.length > 1) rowKey1.removeChild(rowKey1.lastChild);
    while (rowKey2.children.length > 1) rowKey2.removeChild(rowKey2.lastChild);

    if (seq1.length !== 12 || seq2.length !== 12) return;

    // 用來記住調性 1 的第 1 音（之後拿來更新和弦區）
    let firstRootIndex = seq1[0].index;

    // 畫出「調性 1」那排 12 音
    seq1.forEach(obj => {
        const td = document.createElement("td");
        td.textContent = obj.text;
        td.className = "note-cell";
        td.onclick = () => showChordsFromIndex(obj.index); // 點音名 → 更新下面和弦
        rowKey1.appendChild(td);
    });

    // 畫出「調性 2」那排 12 音
    seq2.forEach(obj => {
        const td = document.createElement("td");
        td.textContent = obj.text;
        td.className = "note-cell";
        td.onclick = () => showChordsFromIndex(obj.index);
        rowKey2.appendChild(td);
    });

    // ★ 新增這一行：只要有調性 1，就自動用「第 1 音」更新下面和弦區
    showChordsFromIndex(firstRootIndex);
}

// 綁定下拉選單事件
key1Select.addEventListener("change", render);
key2Select.addEventListener("change", render);

// 綁定「點擊和弦列 → 播放和弦」
rowMaj.addEventListener("click", () => {
    if (currentRootIndex == null) return;
    playChord([
        currentRootIndex,
        (currentRootIndex+4)%12,
        (currentRootIndex+7)%12
    ]);
});

rowMin.addEventListener("click", () => {
    if (currentRootIndex == null) return;
    playChord([
        currentRootIndex,
        (currentRootIndex+3)%12,
        (currentRootIndex+7)%12
    ]);
});

rowDom7.addEventListener("click", () => {
    if (currentRootIndex == null) return;
    playChord([
        currentRootIndex,
        (currentRootIndex+4)%12,
        (currentRootIndex+7)%12,
        (currentRootIndex+10)%12
    ]);
});

rowDom9.addEventListener("click", () => {
    if (currentRootIndex == null) return;
    playChord([
        currentRootIndex,
        (currentRootIndex+4)%12,
        (currentRootIndex+7)%12,
        (currentRootIndex+10)%12,
        (currentRootIndex+2)%12
    ]);
});

// 初始畫面
render();
</script>

</body>
</html>
